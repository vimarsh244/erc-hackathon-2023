import rospy
from nav_msgs.msg import Odometry
from tf.transformations import euler_from_quaternion
from geometry_msgs.msg import Point, Twist
from math import atan2, sqrt

import numpy as np


x = -5.06+1.79
y = -3.12+0.66
theta = 0.0


# List of points to visit
points = [
    [(-5.06, -3.12),(-5.030810611572746, -2.964564276874691), (-5.006301016800769, -2.772969051635586), (-5.01335232539674, -2.5869961083894406), (-5.0450424106615355, -2.4742728427314002), (-5.036214963592425, -2.383971146520099), (-5.048374125472307, -2.034011051710709), (-5.00086422271461, -1.6450587512478214), (-4.953175960331631, -1.436101148115933), (-4.077540661420645, -1.5098627014586885), (-3.964773531420417, -1.2972558822352236), (-3.8118017351888445, -1.3840735612624258), (-3.730303603001504, -1.3985485675835183), (-3.7094535144307286, -1.443201587020344), (-3.66014838330777, -1.4819410170281346), (-3.659422999851919, -1.4884405543523012), (-3.645538366097871, -1.5208430744444097), (-3.649380984679647, -1.5338828589666225), (-3.648125332166168, -1.5780470550398351), (-3.647528984405044, -1.5781526943731792), (-3.648074238280723, -1.5985197576104515), (-3.641469765787517, -1.6613114327598377), (-3.6493182973227603, -1.7084494314381997), (-3.6492284831870823, -1.7331566628068178), (-3.6623673716900242, -1.7343471675100866), (-3.6670099619860563, -1.7740512044370738), (-3.637716655143843, -1.815783523506243), (-3.642944706144448, -1.8634714350453014), (-3.6505573239646565, -1.8982610434254046), (-3.6465919033648135, -1.9169042789395478), (-3.653529349540879, -1.95484288696686), (-3.660604510363207, -1.9591801976824197), (-3.6763174822439173, -1.9608366327179696), (-3.684633560624374, -1.9644091171813383), (-3.6955341450816475, -1.9935269194503724), (-3.7024072189383572, -2.017530873690399), (-3.6954383385730445, -2.036931356671339), (-3.61, -2.2)],
    
          [(-3.61, -2.2), (-3.739408046625473, -1.6827086224626047), (-3.8890816617010344, -1.4129363737165528), (-3.926915553468486, -1.332130358717918), (-4.021589156665527, -1.3646247039588404), (-4.076527587795199, -1.330312779376916), (-4.205658460451751, -1.318728003070993), (-4.260857853356126, -1.3131959585726116), (-4.348198098313259, -1.3375610202842538), (-4.442656924984769, -1.3701698596393375), (-4.502181869378936, -1.3321877120916439), (-4.550916617484979, -1.329063900671144), (-4.631017804544634, -1.305438960536488), (-4.643157472006579, -1.323979261828185), (-4.675583919600465, -1.3473136381717252), (-4.719197234868113, -1.4128620382487767), (-4.773248174293078, -1.4156957968487345), (-4.829621290406107, -1.3588216807425162), (-4.884244512758547, -1.1926675681991692), (-4.900797023667934, -0.9465863422245403), (-4.943406600334173, -0.7082530324173153), (-4.758526422464586, -0.44889470161254075), (-4.637602618481922, -0.20673782101700305), (-4.676137113796832, -0.1522956215954375), (-4.745446298483858, 0.07906336498447045), (-4.7046390000132625, 0.2822708503933409), (-4.638939188887009, 0.5309202773783586), (-4.377817404640279, 0.543859608214403), (-4.292699728723115, 0.6713245379176408), (-3.879396017949983, 0.7538593682974734), (-3.142152975428715, 0.8070645525957367), (-3.087740503142303, 0.835562918272553), (-3.0503476753422882, 0.9076695932756675), (-3.0745887942932146, 1.027420209183763), (-3.1242805492552055, 1.0966555469792563), (-3.064406705627061, 1.266441673580074), (-3.1074639504463293, 1.4171395147175456), (-3.0742542340758705, 1.4210789338612886), (-3.0271744118195, 1.5675462405912708), (-2.5493992253376443, 1.6943500428516978), (-2.527578020000747, 1.7979667249872107), (-2.500508116740664, 1.8100536674500116), (-2.492830935526058, 1.8820909349106287), (-2.4676566976973087, 1.8804881211231141), (-2.28, 1.86)],
          
          [(-2.28, 1.86), (-2.3388036233271974, 1.8243574557365037), (-2.6141478483315947, 1.8189697400940807), (-2.6386083160719407, 1.7266154701996541), (-2.6533090717823975, 1.6615554725281527), (-2.905050779577649, 1.7178235885494337), (-2.9367937387444907, 1.7453014742001265), (-3.0073511389178393, 1.7802557784845208), (-3.2012948851911576, 1.7434119986935868), (-3.34996207253526, 1.7713976546499417), (-3.4613251283393462, 1.5612408531300321), (-3.5233400412830536, 1.379045502173733), (-3.4347274487075086, 1.0695954190540156), (-3.498422731793295, 1.0421539424550705), (-3.5501844763991546, 0.9424968585583862), (-3.390347832199866, 0.7447028762528771), (-3.436273110287628, 0.7185923822913467), (-3.513180733258761, 0.587025406825411), (-3.609250752097875, 0.5690349461766628), (-3.744077629680096, 0.5450614710765473), (-3.8635351948056362, 0.538008093749663), (-3.9492477557041443, 0.5475939746540865), (-4.08659120343246, 0.5842583363834688), (-4.134983666248128, 0.5389279134297853), (-4.195649799163444, 0.5533211436735856), (-4.2540679193363005, 0.5923037792443816), (-4.337337029510487, 0.6648091495472654), (-4.426869137924329, 0.6949503472763635), (-4.5037498712165505, 0.5740252330230866), (-4.579173667828186, 0.5574794396616713), (-4.652454965739406, 0.4350865509469978), (-4.684670086252001, 0.2189408858170762), (-4.7445438691630075, 0.11143167550078714), (-4.71290757583464, 0.037409534730190167), (-4.763566830007837, -0.0359881422767771), (-4.758936492893365, -0.10758479570935923), (-4.789153219883661, -0.16733745990582355), (-4.7384393863344005, -0.36774785404191773), (-4.657135172115578, -0.4184840658840199), (-4.562878014020744, -0.4627221955795945), (-4.468908195585789, -0.45650109507103853), (-4.4577390734271765, -0.4785392768293886), (-4.421672364024202, -0.5327815128908769), (-4.388956873467641, -0.5269828959536262), (-4.372648927244132, -0.5387693280205066), (-4.300654951630915, -0.5090323932557344), (-4.291767170102163, -0.5170229432588396), (-4.240662705487128, -0.5199852505252535), (-4.222056540746351, -0.48029590514470705), (-4.179606954050719, -0.48378978851452903), (-4.143064104792474, -0.5193631192067437), (-4.054720445749804, -0.533818531565298), (-3.9996119384895463, -0.49981130931043194), (-3.951380203553147, -0.49522731786747437), (-3.918542047471147, -0.538766999983107), (-3.84581881329036, -0.5268356443852648), (-3.832885558310978, -0.5237246447629096), (-3.8259687427030533, -0.5384556190285463), (-3.7574594331233344, -0.5256189428316536), (-3.751638659811429, -0.5345981402041925), (-3.6713843208665704, -0.5338240056442829), (-3.6381156597573177, -0.5047110364212026), (-3.5275354914929538, -0.5186079524787205), (-3.4928042773533012, -0.5407104615787597), (-3.4550291085384814, -0.5044275170464839), (-3.3186490423728596, -0.5291362837546447), (-3.2891094678753325, -0.5254019677431633), (-3.223771792480743, -0.5100764042547049), (-3.107226477214977, -0.5087183264504519), (-2.9194887775592524, -0.6185052764073), (-2.4513303343824293, -0.7436750956205608), (-2.332917328381609, -0.698059801451607), (-2.2131048642183497, -0.6912830400095273), (-2.201305691152151, -0.6834472084375351), (-2.076705965536294, -0.82088429636472), (-2.0008274233093206, -0.9129376950997697), (-2.0377188389552052, -0.9808603846268061), (-2.0731094508734964, -1.0215918750769486), (-2.0411697571439165, -1.0481249909487953), (-1.9904842202477457, -1.1447224469043278), (-2.0107115691375084, -1.199808100815694), (-1.9812584150051378, -1.2551788807185322), (-1.9501157853876956, -1.358501276745421), (-1.2269398142694228, -1.3962382590789786), (-0.953136854034738, -1.3460812045871402), (-0.9688993003478444, -1.2668741429185446), (-0.9656808992604944, -1.2138897816080658), (-0.8645357193630215, -1.024236516319597), (-0.8310960486205154, -1.0201507645017773), (-0.8318782612358977, -0.9910128628870811), (-0.8182665893902831, -0.894791430318708), (-0.8390440022385769, -0.890075058989286), (-0.8513548298631605, -0.851199539131149), (-0.853658248429933, -0.7572157476910635), (-0.8248336316887528, -0.7027824793463702), (-0.8050927557978351, -0.6667248351798726), (-0.8484349710823345, -0.606295916709132), (-0.8790013614581978, -0.5866293599636176), (-0.8461117799521837, -0.49466582560464595), (-0.8156234946143038, -0.4482085872077284), (-0.8453780601494247, -0.4272107603452567), (-0.8996711678322582, -0.4055580302118851), (-0.8569038910794713, -0.30380839886820676), (-0.8420800576491718, -0.19333129272701444), (-0.8489281722172584, -0.14827344866077685), (-0.9041334964835713, -0.1292039385960539), (-0.8937560681713667, -0.09226845531672813), (-0.8889560479232603, 0.0220157186667206), (-0.8764583964460589, 0.06794572079675797), (-0.38451369952856485, 0.318388737154265), (-0.053542517333659, 0.504204907200713), (-0.03923259474939702, 0.5119516267930222), (0.30425573023732344, 0.32278555955561217), (0.5074413403412816, 0.18802289474010714), (0.57, 0.33)],
          
          [(0.57, 0.33), (0.4270455223806676, 0.17340838479355203), (0.07134337435688631, 0.16987868701297396), (0.007736824464165501, 0.21749325607738862), (-0.11885021184223339, 0.3711401820407626), (-0.20269615390157497, 0.32629054090601184), (-0.4836473321288082, 0.3259937447378482), (-0.9296724451959586, 0.4462890046384276), (-0.8911712171292198, 0.526449593075349), (-0.9572952944126174, 0.5857584189494797), (-0.9803073556450609, 0.6048001042628486), (-1.122673954042638, 0.7170603812503442), (-1.165630691753381, 0.9452886335818083), (-1.133304516727079, 1.0511192697779967), (-1.1470653798676695, 1.1766792392312917), (-1.1571423407014871, 1.2557858528685695), (-1.049458746267651, 1.4157237010694455), (-1.013877954909601, 1.5738343165091135), (-0.917912452280923, 1.608926980250828), (-0.845778514517132, 1.5932073681445043), (-0.7465231837895047, 1.692062938304001), (-0.7000428800328765, 1.7358938381177693), (-0.6360909810348303, 1.8426501538306106), (-0.652594733199369, 1.8757903193077687), (-0.5204011459012325, 1.96372874390318), (-0.47244007556630085, 1.965761824349671), (-0.3884273773096818, 1.9987924650213031), (-0.3328094113973447, 2.050328696985832), (-0.2985468822315591, 2.0291938490405594), (-0.24539747692367603, 2.015523987274413), (-0.06668970216238962, 2.0756258102175416), (0.04474674165626229, 2.114651947716112), (0.07432433946932351, 2.1254181638657617), (0.1760667992863887, 2.099929434871888), (0.24623607719002039, 2.122004016747019), (0.4590643872954995, 2.1271906925708493), (0.8018824847425521, 2.1338330753377384), (0.8189921401018219, 2.111871432331292), (1.1211137992679507, 2.013453180916371), (1.2752999802866858, 1.9340918172561936), (1.417254490570033, 1.9416633206045404), (1.6908808861315006, 1.8641957622950966), (1.7021130375969133, 1.7886714431925357), (1.717398681818003, 1.6991729213938067), (1.7006153854913484, 1.699487146627508), (1.6876244731903918, 1.6887121741417268), (1.6867605416654852, 1.6763559714398117), (1.654422457142279, 1.6431625787358346), (1.6499792461408411, 1.6118253564114748), (1.6360437043416922, 1.5688169303291895), (1.7055996610982984, 1.5118211343087953), (1.7172310586856694, 1.4083201559140424), (1.68945304993079, 1.3488108313539877), (1.7185535623921997, 1.2881876858313797), (1.7214593654568424, 1.2549347167785885), (1.6746785926020915, 1.2149898771829502), (1.6535786205567167, 1.130274136777234), (1.6299708485501059, 1.070960503728003), (1.707419362479665, 0.9231239571099632), (1.698086854035558, 0.9075757460869804), (1.7071665845363528, 0.8165729939611117), (1.7114887923558766, 0.7598622865585551), (1.7153660503227843, 0.6642486536837239), (1.7157143433403952, 0.6531447672762557), (1.6930291921683174, 0.5841023771018385), (1.698153274010307, 0.4984908745730795), (1.71128822802305, 0.4212047429624141), (1.6984588926792692, 0.39844205485931994), (1.7820274698067422, 0.26287151105942275), (1.9428036246620732, 0.027558148788602632), (2.0346162249478357, -0.021142272256464423), (2.0312171939416084, -0.21311100583016318), (2.043361940346919, -0.31932736387890875), (2.1057828245241343, -0.5051098599437722), (2.054751893861992, -0.5638535612304815), (2.028969045131602, -0.5602706144717369), (1.9608787230080376, -0.5485682726125046), (1.9460835705367812, -0.5311934758994032), (1.910585225717603, -0.5147707657200269), (1.8547988715681678, -0.5188671894310137), (1.7894455346865605, -0.5571167464838451), (1.743125983274228, -0.5475571349415184), (1.7308933921872345, -0.58865224547387), (1.737029841489394, -0.6013111724222028), (1.7352833313437062, -0.6331323831313459), (1.6726553971209044, -0.7152853778274768), (1.6637488988630809, -0.7276744579689723), (1.622024763908162, -0.8202812084142844), (1.6049235003240394, -0.8472972905883974), (1.5369477846328794, -0.9821214065014672), (1.4514585681024004, -1.1065807345961018), (1.4452348598633284, -1.1728514577692837), (1.4096806333141796, -1.2059535260173566), (1.3969342401287546, -1.2468982216506377), (1.41723705900183, -1.3124072978192847), (1.3169654121100023, -1.357688647947508), (1.3023834262073573, -1.3793556303160848), (1.3047659692503133, -1.457733202231049), (1.3565650219493002, -1.5270562532221041), (1.3325111906835343, -1.6009822520925525), (1.4173594292560456, -1.6526993959969007), (1.4235128202813092, -1.6568983882099482), (1.4079348211602445, -1.7090373263331977), (1.3909987484227866, -1.7500433717362396), (1.4273372155550563, -1.7876593821900137), (1.4534283715209342, -1.8070956370404032), (1.5042607485797803, -1.827723246833203), (1.5228380811658813, -1.8325574823760933), (1.5283832631018057, -1.848828715920162), (1.5209556723886122, -1.875460098738985), (1.5136220443513437, -1.8841665024125385), (1.512935432990266, -1.9154324056983107), (1.5188506026589168, -1.9531919162878284), (1.514607692646993, -1.9877928029166543), (1.5247932721223678, -2.016586896531005), (1.5129382905226019, -2.033371081006084), (1.4985856071518544, -2.043805307773541), (1.4977810832069314, -2.064371411774404), (1.5107431885374039, -2.07509610505262), (1.58, -2.26)],
          
          [(1.58, -2.26), (1.414191442654091, -2.036439635569243), (1.3983955024203616, -1.9907392082529234), (1.4620358595300023, -1.712029500472407), (1.459703406489213, -1.2440531729867637), (1.6280661927493543, -0.8372096870997487), (1.8690474300198965, -0.5017732938212777), (1.8870567923129882, -0.5380997838144108), (1.908388987554517, -0.5614633777641963), (1.9284109093521278, -0.5737602851036887), (1.9513696683271962, -0.6250024109875647), (1.9932646272093915, -0.6528664640319335), (2.013045204189571, -0.7041945440267345), (2.0167413614400336, -0.7383563845560754), (2.1066242025006097, -0.8223094447200556), (2.12954129090614, -0.8534542333140861), (2.1363599855548214, -0.9153672402663613), (2.2064239546971387, -0.9241942140671957), (2.226213184926984, -0.9442785568361892), (2.2282119146204886, -1.0162612647599019), (2.224544502647637, -1.0552145425904509), (2.2641609407988237, -1.1429173197623481), (2.36406591741509, -1.2537747380568698), (2.3710146880275946, -1.270478232905337), (2.4784696782292297, -1.3492235404190085), (2.5971640206982727, -1.4137108125704967), (2.62361506679687, -1.4206075643692813), (2.6712327415902797, -1.3951107266882088), (2.748718208640598, -1.3939934835014527), (2.7754021157030966, -1.444111397343507), (2.820357687740425, -1.463702618556456), (2.829494791428814, -1.5084861963185994), (2.8947484012859594, -1.5875091695779535), (3.0828530426140994, -1.631535146985145), (3.0975845763885643, -1.5919748747834264), (3.307941014660513, -1.6336620525028676), (3.5132455514391183, -1.6152054423054407), (3.651524040012934, -1.593569094966753), (3.857377983527357, -1.5384268869976), (3.8905274574691315, -1.5266672960564138), (4.015103693665948, -1.4821185726358774), (4.159408899945111, -1.3706029382218086), (4.216163941455783, -1.436070158397504), (4.23905175274085, -1.489290600156854), (4.280542252051656, -1.5518869969462545), (4.294330524961141, -1.6186264769685696), (4.298207417937142, -1.6797642546075455), (4.283999495919216, -1.7074576813152986), (4.262932197503223, -1.7352837086943396), (4.245598965024136, -1.7547005578679784), (4.238073402734072, -1.797085619305305), (4.251836379279877, -1.8135856893599653), (4.302110352146501, -1.8480936781885804), (4.305504465506108, -1.8840781116772185), (4.301235074637074, -1.8973407442987598), (4.301146248465198, -1.9037556006856753), (4.298063926627776, -1.9418196227247373), (4.294358118434719, -1.9691777673176927), (4.297652150191147, -2.0007125493547946), (4.344734190879146, -2.024902877084378), (4.342879861426821, -2.049561874322178), (4.3527135645052075, -2.0579053713905138), (4.371823647575708, -2.0788866430505903), (4.371270151856478, -2.094759893520028), (4.414249225136937, -2.098801083959303), (4.525592547708962, -2.1023269839547547), (4.543562305317974, -2.0939996854316987), (4.577344315261014, -2.100731438683057), (4.6943690190511225, -2.0947530431451207), (4.716220747539126, -2.1055660647123684), (4.827035699566593, -2.1043131927148484), (4.935265736184449, -2.108932535390624), (5.025456109688518, -2.1231500657114215), (5.18, -2.19)],  
          
          
          ]


goals = [(-3.61, -2.2), (-2.28, 1.86), (0.57, 0.33), (1.58, -2.26), (5.18, -2.19)]

goals = [(round(x+1.79, 2), round(y+0.66, 2)) for x, y in goals]



# for w in points:
#     points[w] = [(round(x+1.79, 2), round(y+0.66, 2)) for x, y in points[w]]


points = [[(round(x+1.79, 2), round(y+0.66, 2)) for x, y in sublist] for sublist in points]


print(points)

def newOdom(msg):
    global x
    global y
    global theta

    x = msg.pose.pose.position.x
    y = msg.pose.pose.position.y

    rot_q = msg.pose.pose.orientation
    # theta = msg.pose.pose.orientation.w
    (roll, pitch, theta) = euler_from_quaternion([rot_q.x, rot_q.y, rot_q.z, rot_q.w])

rospy.init_node("speed_controller")

sub = rospy.Subscriber("/odom", Odometry, newOdom)
pub = rospy.Publisher("/cmd_vel", Twist, queue_size = 1)

speed = Twist()

r = rospy.Rate(100)

goal = Point()
# goal.x = -5.0308+1.79
# goal.y = -2.96+0.66

i = 0 #points in the tragectory
j = 0 # paths

goal.x = points[j][i][0]
goal.y = points[j][i][1]
print(goal)

def dist_raw(a,b):
    euclid_dist = sqrt(a**2 + b**2)
    return euclid_dist

while not rospy.is_shutdown():
    inc_x = goal.x -x
    inc_y = goal.y -y

    angle_to_goal = atan2(inc_y, inc_x)
    
    if(dist_raw(inc_x, inc_y)<0.05 and (angle_to_goal-theta) < 0.1):
        i= i+1
        goal.x = points[j][i][0]
        goal.y = points[j][i][1]
        # print(goal)

    calculate_d_goal = dist_raw((goals[j][0]- x),goals[j][1]- y)
    print(calculate_d_goal)
    if( calculate_d_goal < 0.4):
        i = len(points[j])
        print("reached")
        speed.linear.x = 0
        speed.angular.z = 0
        j = j + 1
        i = 1
    else:
        if (angle_to_goal - theta) > 0.1:
            speed.linear.x = 0.0
            speed.angular.z = 1
        elif (angle_to_goal - theta) < -0.1:
            speed.linear.x = 0.0
            speed.angular.z = -1
        else:
            speed.linear.x = 0.2
            speed.angular.z = 0.0
    
        

    pub.publish(speed)
    r.sleep()

